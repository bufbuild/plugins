From 954221f9d189adcbc6edbae8df92e2040a6b9fcb Mon Sep 17 00:00:00 2001
From: "Philip K. Warren" <pwarren@buf.build>
Date: Mon, 3 Jun 2024 10:22:42 -0500
Subject: [PATCH] Apply plugin patch to v1.4.0

---
 cmd/protoc-gen-go-grpc/grpc.go | 24 ++++++++++++++++++++++--
 cmd/protoc-gen-go-grpc/main.go |  2 ++
 2 files changed, 24 insertions(+), 2 deletions(-)

diff --git a/cmd/protoc-gen-go-grpc/grpc.go b/cmd/protoc-gen-go-grpc/grpc.go
index 9088bc2a..290d012e 100644
--- a/cmd/protoc-gen-go-grpc/grpc.go
+++ b/cmd/protoc-gen-go-grpc/grpc.go
@@ -20,6 +20,7 @@ package main
 
 import (
 	"fmt"
+	"path"
 	"strconv"
 	"strings"
 
@@ -132,8 +133,27 @@ func generateFile(gen *protogen.Plugin, file *protogen.File) *protogen.Generated
 	if len(file.Services) == 0 {
 		return nil
 	}
-	filename := file.GeneratedFilenamePrefix + "_grpc.pb.go"
-	g := gen.NewGeneratedFile(filename, file.GoImportPath)
+	var g *protogen.GeneratedFile
+	if !*separatePackage {
+		filename := file.GeneratedFilenamePrefix + "_grpc.pb.go"
+		g = gen.NewGeneratedFile(filename, file.GoImportPath)
+	} else {
+		file.GoPackageName += "grpc"
+		dir := path.Dir(file.GeneratedFilenamePrefix)
+		base := path.Base(file.GeneratedFilenamePrefix)
+		file.GeneratedFilenamePrefix = path.Join(
+			dir,
+			string(file.GoPackageName),
+			base,
+		)
+		g = gen.NewGeneratedFile(
+			file.GeneratedFilenamePrefix+"_grpc.pb.go",
+			protogen.GoImportPath(path.Join(
+				string(file.GoImportPath),
+				string(file.GoPackageName),
+			)),
+		)
+	}
 	// Attach all comments associated with the syntax field.
 	genLeadingComments(g, file.Desc.SourceLocations().ByPath(protoreflect.SourcePath{fileDescriptorProtoSyntaxFieldNumber}))
 	g.P("// Code generated by protoc-gen-go-grpc. DO NOT EDIT.")
diff --git a/cmd/protoc-gen-go-grpc/main.go b/cmd/protoc-gen-go-grpc/main.go
index 0cb6a021..69055d3e 100644
--- a/cmd/protoc-gen-go-grpc/main.go
+++ b/cmd/protoc-gen-go-grpc/main.go
@@ -45,6 +45,7 @@ const version = "1.4.0"
 
 var requireUnimplemented *bool
 var useGenericStreams *bool
+var separatePackage *bool
 
 func main() {
 	showVersion := flag.Bool("version", false, "print the version and exit")
@@ -57,6 +58,7 @@ func main() {
 	var flags flag.FlagSet
 	requireUnimplemented = flags.Bool("require_unimplemented_servers", true, "set to false to match legacy behavior")
 	useGenericStreams = flags.Bool("use_generic_streams_experimental", false, "set to true to use generic types for streaming client and server objects; this flag is EXPERIMENTAL and may be changed or removed in a future release")
+	separatePackage = flags.Bool("separate_package", false, "set to true to write generated files to a separate grpc package")
 
 	protogen.Options{
 		ParamFunc: flags.Set,
-- 
2.45.2

